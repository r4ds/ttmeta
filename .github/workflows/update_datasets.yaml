name: update-datasets

on:
  schedule:
    - cron: '0 14 * * 1' # 2pm UTC Mondays
  workflow_dispatch:

# Check out and build package, run data-raw/internal.R,
jobs:
  update-datasets:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GH_PAT }}

    steps:
      - uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ env.GITHUB_PAT }}
      # - uses: r-lib/actions/setup-pandoc@v2
      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: release
          use-public-rspm: true
      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::gert, any::fs, any::here
      - name: Update data and commit
        run: |
          gert::git_config_set("user.name", "github-actions")
          gert::git_config_set("user.email", "github-actions@github.com")
          
          target <- here::here("R/sysdata.rda")
          original_sysdata_dt <- fs::file_info(target)$modification_time
          source("data-raw/just-new.R", echo = FALSE)
          cli::cli_alert_info("target path = {target}")
          if (fs::file_info(target)$modification_time != original_sysdata_dt) {
            cli::cli_alert_success("sysdata updated, committing.")
            gert::git_add(target)
            #if (any(gert::git_status()$staged)) {
              cli::cli_alert_info("Committing.")
              gert::git_commit_all("ðŸ¤– Auto-update internal data")
              cli::cli_alert_info("Pushing.")
              gert::git_push()
           # } else {
           #   cli::cli_alert_info("No dataset updates.")
           # }
          } else {
            cli::cli_abort("Didn't write.")
          }
        shell: Rscript {0}
